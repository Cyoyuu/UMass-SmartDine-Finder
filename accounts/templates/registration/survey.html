{% extends "base.html" %}
{% block content %}

<style>
  main {
    max-width: 1100px !important;
    padding: 20px !important;
    background: transparent !important;
    border: none !important;
  }

  /* Page Header with gradient accent */
  .page-header {
    margin-bottom: 24px;
    padding: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    color: #fff;
    position: relative;
    overflow: hidden;
  }
  
  .page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
  }
  
  .page-header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: 10%;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.05);
    border-radius: 50%;
  }

  .page-header-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .page-header-icon {
    width: 56px;
    height: 56px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    margin: 0 0 4px 0;
  }

  .page-subtitle {
    font-size: 14px;
    color: rgba(255,255,255,0.85);
    margin: 0;
  }

  /* History Card - Top Section */
  .history-card {
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }
  
  .history-card:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .history-title-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .history-icon {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .history-title {
    font-size: 15px;
    font-weight: 600;
    color: #0f172a;
    margin: 0;
  }

  .history-subtitle {
    font-size: 12px;
    color: #94a3b8;
    margin: 2px 0 0 0;
  }

  .history-timeline {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 8px;
  }

  .history-day {
    flex: 0 0 auto;
    width: 130px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .history-day:hover {
    border-color: #6366f1;
    background: #fafaff;
  }

  .history-day.today { border-width: 2px; border-color: #6366f1; }
  .history-day.empty { opacity: 0.6; }

  .history-day-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .history-day-date {
    font-size: 11px;
    color: #64748b;
    font-weight: 500;
  }

  .history-day-weekday {
    font-size: 13px;
    font-weight: 600;
    color: #0f172a;
    margin-top: 2px;
  }

  .today-badge {
    font-size: 9px;
    padding: 2px 6px;
    background: #6366f1;
    color: #fff;
    border-radius: 4px;
    font-weight: 600;
  }

  .history-day-stats {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .history-stat-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
  }

  .history-stat-icon { width: 14px; font-size: 10px; }
  .history-stat-icon.cal { color: #f59e0b; }
  .history-stat-icon.meals { color: #22c55e; }
  .history-stat-icon.hall { color: #6366f1; }

  .history-stat-value { color: #374151; font-weight: 500; }
  .history-stat-empty { color: #94a3b8; font-style: italic; }

  /* Main Grid */
  .prefs-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 20px;
  }

  /* Cards */
  .card {
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    transition: box-shadow 0.3s ease;
  }
  
  .card:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
  }

  /* Form Sections */
  .form-section { margin-bottom: 24px; }
  .form-section:last-of-type { margin-bottom: 0; }

  .section-label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .section-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }

  .section-icon.allergen { 
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%); 
    color: #dc2626; 
  }
  .section-icon.calorie { 
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
    color: #d97706; 
  }
  .section-icon.diet { 
    background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%); 
    color: #16a34a; 
  }

  /* Checkbox Grid */
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .checkbox-item { cursor: pointer; }
  .checkbox-item input { display: none; }

  .checkbox-box {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    transition: all 0.2s ease;
  }

  .checkbox-item:hover .checkbox-box { 
    border-color: #c7d2fe; 
    background: #fafaff;
    transform: translateY(-1px);
  }
  
  .checkbox-item input:checked + .checkbox-box { 
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); 
    border-color: #6366f1;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
  }

  .check-indicator {
    width: 18px;
    height: 18px;
    border: 2px solid #d1d5db;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: transparent;
    transition: all 0.2s ease;
  }

  .checkbox-item input:checked + .checkbox-box .check-indicator {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }

  .checkbox-text { 
    font-size: 13px; 
    color: #374151; 
    font-weight: 500; 
  }
  
  .checkbox-item input:checked + .checkbox-box .checkbox-text {
    color: #4338ca;
    font-weight: 600;
  }

  /* Calorie Slider */
  .calorie-wrapper {
    text-align: center;
    padding: 24px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 14px;
    border: 1px solid #e2e8f0;
  }

  .calorie-value { 
    font-size: 48px; 
    font-weight: 700; 
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1; 
  }
  .calorie-unit { font-size: 14px; color: #94a3b8; margin-left: 6px; }

  .calorie-slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 100%);
    outline: none;
    -webkit-appearance: none;
    margin: 20px 0;
  }

  .calorie-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    transition: all 0.2s ease;
  }
  
  .calorie-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
  }

  .preset-btns { display: flex; gap: 10px; justify-content: center; }

  .preset-btn {
    padding: 8px 18px;
    border: 2px solid #e2e8f0;
    background: #fff;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .preset-btn:hover { 
    border-color: #6366f1; 
    color: #6366f1; 
    background: #f5f3ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
  }

  /* Action Buttons */
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #f1f5f9;
  }

  .btn-primary {
    flex: 1;
    padding: 14px 24px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
  }

  .btn-ghost {
    padding: 14px 24px;
    background: transparent;
    color: #64748b;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
  }

  .btn-ghost:hover { 
    border-color: #6366f1; 
    color: #6366f1;
    background: #f5f3ff;
  }

  /* Stats Column */
  .stats-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .stat-card {
    background: #fff;
    border-radius: 14px;
    border: 1px solid #e2e8f0;
    padding: 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    transition: all 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    border-color: #d1d5db;
  }

  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .stat-title { font-size: 13px; font-weight: 600; color: #0f172a; margin: 0; }
  .stat-badge { font-size: 10px; padding: 3px 8px; background: #f1f5f9; color: #64748b; border-radius: 4px; }

  /* Weekly Chart */
  .weekly-chart {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    height: 100px;
    padding: 8px 0;
  }

  .chart-bar-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
  }

  .chart-bar {
    width: 24px;
    background: linear-gradient(180deg, #6366f1 0%, #818cf8 100%);
    border-radius: 4px 4px 0 0;
    transition: height 0.3s ease;
    min-height: 4px;
  }

  .chart-bar.target { background: linear-gradient(180deg, #22c55e 0%, #4ade80 100%); }
  .chart-bar.over { background: linear-gradient(180deg, #f59e0b 0%, #fbbf24 100%); }

  .chart-label { font-size: 10px; color: #94a3b8; margin-top: 6px; }
  .chart-value { font-size: 10px; color: #64748b; margin-bottom: 4px; font-weight: 500; }

  /* Donut Chart */
  .donut-container { display: flex; align-items: center; gap: 20px; }
  .donut-chart { position: relative; width: 100px; height: 100px; }
  .donut-chart svg { transform: rotate(-90deg); }
  .donut-chart circle { fill: none; stroke-width: 12; }
  .donut-bg { stroke: #f1f5f9; }
  .donut-segment { stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
  .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
  .donut-value { font-size: 18px; font-weight: 700; color: #0f172a; line-height: 1; }
  .donut-label { font-size: 10px; color: #94a3b8; }
  .donut-legend { flex: 1; }
  .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; }
  .legend-item:last-child { margin-bottom: 0; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
  .legend-dot.breakfast { background: #6366f1; }
  .legend-dot.lunch { background: #22c55e; }
  .legend-dot.dinner { background: #f59e0b; }
  .legend-name { flex: 1; color: #64748b; }
  .legend-value { font-weight: 600; color: #0f172a; }

  /* Top Halls */
  .top-halls { display: flex; flex-direction: column; gap: 8px; }

  .hall-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background: #f8fafc;
    border-radius: 8px;
  }

  .hall-rank {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
  }

  .hall-rank.r1 { background: #fef3c7; color: #d97706; }
  .hall-rank.r2 { background: #f1f5f9; color: #64748b; }
  .hall-rank.r3 { background: #fef2f2; color: #dc2626; }

  .hall-name { flex: 1; font-size: 13px; font-weight: 500; color: #374151; }
  .hall-visits { font-size: 12px; color: #94a3b8; }
  .hall-bar-container { width: 60px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
  .hall-bar { height: 100%; background: #6366f1; border-radius: 3px; }

  /* Summary Stats */
  .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }

  .summary-item {
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    text-align: center;
  }

  .summary-value { font-size: 20px; font-weight: 700; color: #6366f1; line-height: 1; }
  .summary-label { font-size: 11px; color: #94a3b8; margin-top: 4px; }

  /* History Detail Modal */
  .history-detail-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .history-detail-overlay.active { display: flex; }

  .history-detail-modal {
    background: #fff;
    border-radius: 16px;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .history-detail-header {
    padding: 20px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff;
    position: relative;
  }

  .history-detail-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .history-detail-close:hover { background: rgba(255, 255, 255, 0.3); }
  .history-detail-date { font-size: 24px; font-weight: 700; margin: 0; }
  .history-detail-day { font-size: 14px; opacity: 0.9; margin-top: 4px; }
  .history-detail-summary { display: flex; gap: 20px; margin-top: 16px; }
  .history-summary-stat { display: flex; flex-direction: column; gap: 2px; }
  .history-summary-value { font-size: 20px; font-weight: 700; }
  .history-summary-label { font-size: 11px; opacity: 0.8; }
  .history-detail-content { padding: 20px; max-height: 400px; overflow-y: auto; }
  .history-meal-section { margin-bottom: 20px; }
  .history-meal-section:last-child { margin-bottom: 0; }

  .history-meal-title {
    font-size: 13px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .history-meal-icon { font-size: 14px; }
  
  .history-meal-count {
    margin-left: auto;
    font-size: 11px;
    font-weight: 500;
    color: #94a3b8;
  }
  .history-meal-list { display: flex; flex-direction: column; gap: 8px; }

  .history-meal-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .history-meal-name { font-size: 13px; font-weight: 500; color: #374151; }
  .history-meal-meta { display: flex; align-items: center; gap: 12px; font-size: 12px; color: #64748b; }
  .history-meal-cal { display: flex; align-items: center; gap: 4px; }

  .history-meal-hall {
    padding: 2px 8px;
    background: #eef2ff;
    color: #6366f1;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
  }

  .history-empty-state { text-align: center; padding: 40px 20px; color: #94a3b8; }
  .history-empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
  .history-empty-text { font-size: 14px; margin: 0; }

  /* Responsive */
  @media (max-width: 900px) {
    .prefs-grid { grid-template-columns: 1fr; }
    .stats-column { flex-direction: row; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 280px; }
  }

  @media (max-width: 600px) {
    .checkbox-grid { grid-template-columns: repeat(2, 1fr); }
    .donut-container { flex-direction: column; }
    .stats-column { flex-direction: column; }
    .stat-card { min-width: 100%; }
    .history-day { width: 100px; }
  }
</style>

<div class="page-header">
  <div class="page-header-content">
    <div class="page-header-icon">‚öôÔ∏è</div>
    <div>
      <h1 class="page-title">Dietary Preferences</h1>
      <p class="page-subtitle">Customize your dining experience with personalized recommendations</p>
    </div>
  </div>
</div>

<!-- Meal History Card - TOP SECTION -->
<div class="history-card">
  <div class="history-header">
    <div class="history-title-group">
      <div class="history-icon">üìÖ</div>
      <div>
        <h3 class="history-title">Meal History</h3>
        <p class="history-subtitle">Your selections from the past 7 days</p>
      </div>
    </div>
  </div>
  
  <div class="history-timeline" id="historyTimeline">
    <div class="history-day empty">
      <div class="history-day-header">
        <div>
          <div class="history-day-date">Loading...</div>
          <div class="history-day-weekday">...</div>
        </div>
      </div>
      <div class="history-day-stats">
        <div class="history-stat-row">
          <span class="history-stat-empty">Loading data...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="prefs-grid">
  <!-- Left Column: Preferences Form -->
  <div class="card">
    <form method="post" id="prefsForm">
      {% csrf_token %}
      
      <!-- Allergens -->
      <div class="form-section">
        <div class="section-label">
          <span class="section-icon allergen">!</span>
          Food Allergies
        </div>
        <div class="checkbox-grid">
          {% for value, label in allergen_choices %}
          <label class="checkbox-item">
            <input type="checkbox" name="allergens" value="{{ value }}"
                   {% if value in profile.allergens %}checked{% endif %}>
            <div class="checkbox-box">
              <span class="check-indicator">‚úì</span>
              <span class="checkbox-text">{{ label }}</span>
            </div>
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- Calorie Target -->
      <div class="form-section">
        <div class="section-label">
          <span class="section-icon calorie">~</span>
          Daily Calorie Target
        </div>
        <div class="calorie-wrapper">
          <span class="calorie-value" id="calorieDisplay">{{ profile.calorieTarget|default:2000 }}</span>
          <span class="calorie-unit">kcal/day</span>
          <input type="range" class="calorie-slider" id="calorieSlider" name="calorieTarget"
                 min="1000" max="4000" step="100"
                 value="{{ profile.calorieTarget|default:2000 }}"
                 oninput="updateCalorie(this.value)">
          <div class="preset-btns">
            <button type="button" class="preset-btn" onclick="setCalorie(1500)">Weight Loss</button>
            <button type="button" class="preset-btn" onclick="setCalorie(2000)">Maintain</button>
            <button type="button" class="preset-btn" onclick="setCalorie(2500)">Muscle Gain</button>
          </div>
        </div>
      </div>

      <!-- Diet Preferences -->
      <div class="form-section">
        <div class="section-label">
          <span class="section-icon diet">‚úì</span>
          Diet Preferences
        </div>
        <div class="checkbox-grid">
          {% for value, label in diet_choices %}
          <label class="checkbox-item">
            <input type="checkbox" name="dietPreferences" value="{{ value }}"
                   {% if value in profile.dietPreferences %}checked{% endif %}>
            <div class="checkbox-box">
              <span class="check-indicator">‚úì</span>
              <span class="checkbox-text">{{ label }}</span>
            </div>
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">Save Preferences</button>
        <a href="{% url 'skip_survey' %}" class="btn-ghost">Skip</a>
      </div>
    </form>
  </div>

  <!-- Right Column: Stats (Dynamic from History) -->
  <div class="stats-column">
    <!-- Weekly Calories -->
    <div class="stat-card">
      <div class="stat-header">
        <h3 class="stat-title">Weekly Calories</h3>
        <span class="stat-badge">Last 7 days</span>
      </div>
      <div class="weekly-chart" id="weeklyChart">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Meal Distribution -->
    <div class="stat-card">
      <div class="stat-header">
        <h3 class="stat-title">Meal Distribution</h3>
        <span class="stat-badge">This week</span>
      </div>
      <div class="donut-container">
        <div class="donut-chart">
          <svg width="100" height="100" viewBox="0 0 100 100">
            <circle class="donut-bg" cx="50" cy="50" r="40" />
            <circle class="donut-segment" id="donutBreakfast" cx="50" cy="50" r="40" stroke="#6366f1" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle class="donut-segment" id="donutLunch" cx="50" cy="50" r="40" stroke="#22c55e" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
            <circle class="donut-segment" id="donutDinner" cx="50" cy="50" r="40" stroke="#f59e0b" stroke-dasharray="0 251.2" stroke-dashoffset="0" />
          </svg>
          <div class="donut-center">
            <div class="donut-value" id="totalMealsDonut">0</div>
            <div class="donut-label">meals</div>
          </div>
        </div>
        <div class="donut-legend">
          <div class="legend-item">
            <span class="legend-dot breakfast"></span>
            <span class="legend-name">Breakfast</span>
            <span class="legend-value" id="breakfastPercent">0%</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot lunch"></span>
            <span class="legend-name">Lunch</span>
            <span class="legend-value" id="lunchPercent">0%</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot dinner"></span>
            <span class="legend-name">Dinner</span>
            <span class="legend-value" id="dinnerPercent">0%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Most Visited -->
    <div class="stat-card">
      <div class="stat-header">
        <h3 class="stat-title">Most Visited</h3>
        <span class="stat-badge">Last 7 days</span>
      </div>
      <div class="top-halls" id="topHalls">
        <div class="hall-row">
          <span class="hall-rank r1">-</span>
          <span class="hall-name">No data yet</span>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="stat-card">
      <div class="stat-header">
        <h3 class="stat-title">Quick Stats</h3>
      </div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value" id="avgDailyCal">0</div>
          <div class="summary-label">Avg Daily Cal</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="totalMeals">0</div>
          <div class="summary-label">Total Meals</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="daysTracked">0</div>
          <div class="summary-label">Days Tracked</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="avgMatchRate">-</div>
          <div class="summary-label">Top Hall</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Detail Modal -->
<div class="history-detail-overlay" id="historyDetailOverlay">
  <div class="history-detail-modal">
    <div class="history-detail-header">
      <button class="history-detail-close" onclick="closeHistoryDetail()">&times;</button>
      <h2 class="history-detail-date" id="detailDate">Dec 05</h2>
      <p class="history-detail-day" id="detailDay">Thursday</p>
      <div class="history-detail-summary">
        <div class="history-summary-stat">
          <span class="history-summary-value" id="detailCalories">0</span>
          <span class="history-summary-label">Calories</span>
        </div>
        <div class="history-summary-stat">
          <span class="history-summary-value" id="detailMealCount">0</span>
          <span class="history-summary-label">Items</span>
        </div>
        <div class="history-summary-stat">
          <span class="history-summary-value" id="detailHall">-</span>
          <span class="history-summary-label">Primary Hall</span>
        </div>
      </div>
    </div>
    <div class="history-detail-content" id="detailContent"></div>
  </div>
</div>

<script>
  // Preferences functions
  function updateCalorie(value) {
    document.getElementById('calorieDisplay').textContent = value;
    savePrefsToLocalStorage();
  }

  function setCalorie(value) {
    document.getElementById('calorieSlider').value = value;
    updateCalorie(value);
  }

  function savePrefsToLocalStorage() {
    const allergens = Array.from(document.querySelectorAll('input[name="allergens"]:checked')).map(el => el.value);
    const dietPreferences = Array.from(document.querySelectorAll('input[name="dietPreferences"]:checked')).map(el => el.value);
    const calorieTarget = parseInt(document.getElementById('calorieSlider').value) || 2000;
    
    const prefs = { allergens, dietPreferences, calorieTarget };
    localStorage.setItem('userPreferences', JSON.stringify(prefs));
  }

  // ============== Meal History Functions ==============
  let historyData = [];
  const calorieTarget = {{ profile.calorieTarget|default:2000 }};

  async function loadMealHistory() {
    try {
      const response = await fetch('/menus/history/');
      const data = await response.json();
      
      if (data.success) {
        historyData = data.history;
        renderHistoryTimeline();
        updateAllStats();
      } else {
        renderEmptyTimeline();
      }
    } catch (error) {
      console.error('Error loading meal history:', error);
      renderEmptyTimeline();
    }
  }

  function renderHistoryTimeline() {
    const container = document.getElementById('historyTimeline');
    if (!container) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    let html = '';
    historyData.forEach((day) => {
      const isToday = day.date === today;
      const isEmpty = !day.hasData;
      
      html += `
        <div class="history-day ${isToday ? 'today' : ''} ${isEmpty ? 'empty' : ''}" 
             onclick="openHistoryDetail('${day.date}')" data-date="${day.date}">
          <div class="history-day-header">
            <div>
              <div class="history-day-date">${day.dateDisplay}</div>
              <div class="history-day-weekday">${day.dayOfWeek}</div>
            </div>
            ${isToday ? '<span class="today-badge">Today</span>' : ''}
          </div>
          <div class="history-day-stats">
            ${isEmpty ? `<div class="history-stat-row"><span class="history-stat-empty">No meals</span></div>` : `
              <div class="history-stat-row">
                <span class="history-stat-icon cal">üî•</span>
                <span class="history-stat-value">${day.totalCalories} cal</span>
              </div>
              <div class="history-stat-row">
                <span class="history-stat-icon meals">üçΩÔ∏è</span>
                <span class="history-stat-value">${day.mealCount} items</span>
              </div>
              ${day.primaryHall ? `
                <div class="history-stat-row">
                  <span class="history-stat-icon hall">üìç</span>
                  <span class="history-stat-value">${day.primaryHall}</span>
                </div>
              ` : ''}
            `}
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function renderEmptyTimeline() {
    const container = document.getElementById('historyTimeline');
    if (!container) return;
    
    const today = new Date();
    let html = '';
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
      const dateDisplay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const isToday = i === 0;
      
      html += `
        <div class="history-day empty ${isToday ? 'today' : ''}" data-date="${dateStr}">
          <div class="history-day-header">
            <div>
              <div class="history-day-date">${dateDisplay}</div>
              <div class="history-day-weekday">${dayName}</div>
            </div>
            ${isToday ? '<span class="today-badge">Today</span>' : ''}
          </div>
          <div class="history-day-stats">
            <div class="history-stat-row"><span class="history-stat-empty">No meals</span></div>
          </div>
        </div>
      `;
    }
    
    container.innerHTML = html;
  }

  function updateAllStats() {
    let totalCalories = 0;
    let totalMeals = 0;
    let daysWithData = 0;
    let breakfastCount = 0, lunchCount = 0, dinnerCount = 0;
    const hallCounts = {};

    historyData.forEach(day => {
      if (day.hasData) {
        totalCalories += day.totalCalories;
        totalMeals += day.mealCount;
        daysWithData++;
        
        // Count by meal type from summary
        if (day.summary) {
          breakfastCount += day.summary.breakfastCount || 0;
          lunchCount += day.summary.lunchCount || 0;
          dinnerCount += day.summary.dinnerCount || 0;
        }
        
        // Count halls from individual meals (not from primaryHall)
        if (day.meals && Array.isArray(day.meals)) {
          day.meals.forEach(meal => {
            const hall = meal.hall || meal.diningHall;
            if (hall) {
              hallCounts[hall] = (hallCounts[hall] || 0) + 1;
            }
          });
        }
      }
    });

    const avgCalories = daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0;

    // Update Quick Stats
    document.getElementById('avgDailyCal').textContent = avgCalories.toLocaleString();
    document.getElementById('totalMeals').textContent = totalMeals;
    document.getElementById('daysTracked').textContent = daysWithData;

    // Update Weekly Chart
    updateWeeklyChart();

    // Update Donut Chart
    updateDonutChart(breakfastCount, lunchCount, dinnerCount);

    // Update Most Visited
    updateMostVisited(hallCounts);
  }

  function updateWeeklyChart() {
    const container = document.getElementById('weeklyChart');
    if (!container) return;

    const maxCal = Math.max(...historyData.map(d => d.totalCalories || 0), calorieTarget);
    
    let html = '';
    // Reverse to show oldest first (left to right)
    const reversed = [...historyData].reverse();
    
    reversed.forEach(day => {
      const cal = day.totalCalories || 0;
      const height = maxCal > 0 ? Math.max(4, (cal / maxCal) * 100) : 4;
      let barClass = '';
      if (cal > 0) {
        if (cal >= calorieTarget * 0.9 && cal <= calorieTarget * 1.1) {
          barClass = 'target';
        } else if (cal > calorieTarget * 1.1) {
          barClass = 'over';
        }
      }
      
      html += `
        <div class="chart-bar-group">
          <span class="chart-value">${cal || '-'}</span>
          <div class="chart-bar ${barClass}" style="height: ${height}%;"></div>
          <span class="chart-label">${day.dayOfWeek}</span>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function updateDonutChart(breakfast, lunch, dinner) {
    const total = breakfast + lunch + dinner;
    document.getElementById('totalMealsDonut').textContent = total;
    
    if (total === 0) {
      document.getElementById('breakfastPercent').textContent = '0%';
      document.getElementById('lunchPercent').textContent = '0%';
      document.getElementById('dinnerPercent').textContent = '0%';
      return;
    }
    
    const circumference = 2 * Math.PI * 40; // ~251.2
    const bPct = Math.round((breakfast / total) * 100);
    const lPct = Math.round((lunch / total) * 100);
    const dPct = Math.round((dinner / total) * 100);
    
    document.getElementById('breakfastPercent').textContent = bPct + '%';
    document.getElementById('lunchPercent').textContent = lPct + '%';
    document.getElementById('dinnerPercent').textContent = dPct + '%';
    
    // Update SVG segments
    const bLen = (breakfast / total) * circumference;
    const lLen = (lunch / total) * circumference;
    const dLen = (dinner / total) * circumference;
    
    document.getElementById('donutBreakfast').setAttribute('stroke-dasharray', `${bLen} ${circumference}`);
    document.getElementById('donutLunch').setAttribute('stroke-dasharray', `${lLen} ${circumference}`);
    document.getElementById('donutLunch').setAttribute('stroke-dashoffset', -bLen);
    document.getElementById('donutDinner').setAttribute('stroke-dasharray', `${dLen} ${circumference}`);
    document.getElementById('donutDinner').setAttribute('stroke-dashoffset', -(bLen + lLen));
  }

  function updateMostVisited(hallCounts) {
    const container = document.getElementById('topHalls');
    if (!container) return;
    
    const sorted = Object.entries(hallCounts).sort((a, b) => b[1] - a[1]);
    const maxVisits = sorted.length > 0 ? sorted[0][1] : 1;
    
    if (sorted.length === 0) {
      container.innerHTML = `<div class="hall-row"><span class="hall-rank r1">-</span><span class="hall-name">No data yet</span></div>`;
      document.getElementById('avgMatchRate').textContent = '-';
      return;
    }
    
    // Find all halls with the top count (for ties)
    const topCount = sorted[0][1];
    const topHalls = sorted.filter(([hall, count]) => count === topCount);
    
    // Display top hall(s) - if tied, show all
    if (topHalls.length === 1) {
      document.getElementById('avgMatchRate').textContent = topHalls[0][0];
    } else {
      document.getElementById('avgMatchRate').textContent = topHalls.map(h => h[0]).join(', ');
    }
    
    // Group halls by their count to handle ties in ranking
    let html = '';
    let currentRank = 1;
    let lastCount = -1;
    let displayCount = 0;
    
    sorted.forEach((entry, i) => {
      if (displayCount >= 5) return; // Show max 5 entries
      
      const [hall, visits] = entry;
      
      // Update rank only when count changes
      if (visits !== lastCount) {
        currentRank = i + 1;
        lastCount = visits;
      }
      
      const rankClass = currentRank === 1 ? 'r1' : currentRank === 2 ? 'r2' : 'r3';
      const barWidth = (visits / maxVisits) * 100;
      displayCount++;
      
      html += `
        <div class="hall-row">
          <span class="hall-rank ${rankClass}">${i + 1}</span>
          <span class="hall-name">${hall}</span>
          <span class="hall-visits">${visits} items</span>
          <div class="hall-bar-container">
            <div class="hall-bar" style="width: ${barWidth}%;"></div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  async function openHistoryDetail(dateStr) {
    try {
      const response = await fetch(`/menus/history/${dateStr}/`);
      const data = await response.json();
      
      if (data.success && data.record) {
        showHistoryDetailModal(data.record);
      } else {
        showEmptyHistoryDetail(dateStr);
      }
    } catch (error) {
      showEmptyHistoryDetail(dateStr);
    }
  }

  function showHistoryDetailModal(record) {
    document.getElementById('detailDate').textContent = record.dateDisplay;
    document.getElementById('detailDay').textContent = record.dayOfWeek;
    document.getElementById('detailCalories').textContent = record.totalCalories;
    document.getElementById('detailMealCount').textContent = record.mealCount;
    document.getElementById('detailHall').textContent = record.primaryHall || '-';
    
    const mealsByType = record.mealsByType || { breakfast: [], lunch: [], dinner: [], snack: [] };
    let contentHtml = '';
    let hasAnyMeals = false;
    
    [
      { key: 'breakfast', label: 'Breakfast', icon: 'üåÖ' },
      { key: 'lunch', label: 'Lunch', icon: '‚òÄÔ∏è' },
      { key: 'dinner', label: 'Dinner', icon: 'üåô' },
      { key: 'snack', label: 'Snacks', icon: 'üç™' }
    ].forEach(type => {
      const meals = mealsByType[type.key] || [];
      if (meals.length > 0) {
        hasAnyMeals = true;
        
        // Get unique halls for this meal type
        const hallsForMeal = [...new Set(meals.map(m => m.hall || m.diningHall).filter(Boolean))];
        const hallLabel = hallsForMeal.length > 0 ? ` @ ${hallsForMeal.join(', ')}` : '';
        
        contentHtml += `
          <div class="history-meal-section">
            <div class="history-meal-title">
              <span class="history-meal-icon">${type.icon}</span>
              ${type.label}${hallLabel}
              <span class="history-meal-count">${meals.length} items</span>
            </div>
            <div class="history-meal-list">
              ${meals.map(meal => `
                <div class="history-meal-item">
                  <span class="history-meal-name">${meal.name || 'Unknown'}</span>
                  <div class="history-meal-meta">
                    <span class="history-meal-cal">üî• ${meal.calories || 0}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    });
    
    if (!hasAnyMeals) {
      contentHtml = `<div class="history-empty-state"><div class="history-empty-icon">üì≠</div><p class="history-empty-text">No meals logged</p></div>`;
    }
    
    document.getElementById('detailContent').innerHTML = contentHtml;
    document.getElementById('historyDetailOverlay').classList.add('active');
  }

  function showEmptyHistoryDetail(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    document.getElementById('detailDate').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    document.getElementById('detailDay').textContent = date.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById('detailCalories').textContent = '0';
    document.getElementById('detailMealCount').textContent = '0';
    document.getElementById('detailHall').textContent = '-';
    document.getElementById('detailContent').innerHTML = `<div class="history-empty-state"><div class="history-empty-icon">üì≠</div><p class="history-empty-text">No meals logged</p></div>`;
    document.getElementById('historyDetailOverlay').classList.add('active');
  }

  function closeHistoryDetail() {
    document.getElementById('historyDetailOverlay').classList.remove('active');
  }

  // Event listeners
  document.getElementById('historyDetailOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeHistoryDetail();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeHistoryDetail();
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    savePrefsToLocalStorage();
    loadMealHistory();
    
    document.querySelectorAll('input[name="allergens"], input[name="dietPreferences"]').forEach(input => {
      input.addEventListener('change', savePrefsToLocalStorage);
    });
  });

  document.getElementById('prefsForm').addEventListener('submit', function() {
    savePrefsToLocalStorage();
  });
</script>

{% endblock %}
